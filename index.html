<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Kitava Delivery Density</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body { height:100%; margin:0; font-family: Arial, sans-serif; }
    #map { height:100vh; }
    #controls {
      position:absolute; top:12px; left:12px; z-index:1000;
      background:white; padding:10px; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2); width:360px;
    }
    textarea { width:100%; height:130px; font-size:12px; }
    button { margin-top:6px; padding:6px 10px; }
    .legend {
      position:absolute; top:12px; right:12px; z-index:1000;
      background:white; padding:8px; border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,0.2); font-size:13px;
    }
  </style>
</head>
<body>

<div id="controls">
  <strong>Paste CSV (Raw) and Load</strong>
  <textarea id="csvbox"></textarea>
  <button onclick="loadMap()">Load Map</button>
</div>

<div id="map"></div>

<div class="legend">
  <div><strong>Store</strong></div>
  <div style="color:#1f78b4">■ Albany</div>
  <div style="color:#33a02c">■ Temescal</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
const map = L.map('map').setView([37.87, -122.27], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let layer;

function loadMap() {
  const csv = document.getElementById('csvbox').value.trim();
  if (!csv) {
    alert("Paste CSV text first");
    return;
  }

  const parsed = Papa.parse(csv, {header:true});
  const pts = [];

  parsed.data.forEach(r => {
    const lat = parseFloat(r["Cx Lat"]);
    const lon = parseFloat(r["Cx Long"]);
    const store = r["Store Name"];
    const count = parseInt(r["# of Deliveries"]) || 0;

    if (isFinite(lat) && isFinite(lon)) {
      pts.push(turf.point([lon, lat], {store, count}));
    }
  });

  const fc = turf.featureCollection(pts);
  const bbox = turf.bbox(fc);
  const grid = turf.hexGrid(bbox, 0.5, {units:"kilometers"});

  grid.features.forEach(hex => {
    let albany = 0;
    let temescal = 0;

    pts.forEach(p => {
      if (turf.booleanPointInPolygon(p, hex)) {
        if (p.properties.store.includes("Albany")) albany += p.properties.count;
        if (p.properties.store.includes("Temescal")) temescal += p.properties.count;
      }
    });

    hex.properties.albany = albany;
    hex.properties.temescal = temescal;
    hex.properties.total = albany + temescal;
    hex.properties.winner = albany >= temescal ? "Albany" : "Temescal";
  });

  if (layer) map.removeLayer(layer);

  layer = L.geoJSON(grid, {
    style: f => ({
      color:"#777",
      weight:0.5,
      fillOpacity:0.7,
      fillColor: f.properties.winner === "Albany" ? "#1f78b4" : "#33a02c"
    }),
    onEachFeature: (f,l) => {
      l.bindTooltip(
        `<strong>${f.properties.winner}</strong><br/>
         Albany: ${f.properties.albany}<br/>
         Temescal: ${f.properties.temescal}`
      );
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds());
}
</script>

</body>
</html>
